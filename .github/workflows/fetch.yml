name: De paseo por el metaverso más foral

on:
  push:
    paths:
      - '**.js'
      - '**.yml'
  schedule:
    - cron: '*/5 * * * *'

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Trae el repositorio
        uses: actions/checkout@v2
        with:
          persist-credentials: false
          fetch-depth: 0
      - name: Captura el estado de las salas
        env:
          TWITTER_CONSUMER_API_KEY: ${{ secrets.TWITTER_CONSUMER_API_KEY }}
          TWITTER_CONSUMER_API_SECRET: ${{ secrets.TWITTER_CONSUMER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
        run: |-
          CREDENTIALS="Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2NTI0MzU0NjYsImlhdCI6MTY1MjM0OTA2NiwiaXNzIjoiaHR0cHM6Ly9hcGkuc3BhdGlhbC5pbyIsIm5vYXV0aCI6dHJ1ZSwicm9vbWlkIjoiNjI0NmI3MDY0ZjdhOTMwMDAxYTc2Mzc1Iiwic3ViIjoibm9hdXRofDYyN2NkNjJmZjdkYTMxMDAwMTc3ZjY5YyIsInVpZCI6IjYyN2NkNjJmZjdkYTMxMDAwMTc3ZjY5YyJ9._i3CYUS4u3Nr8XJU__qJI0_87TUcf56ppLJF0fJsrhQ"

          ROOMS=(
            6246b6964f7a930001a7636a # Sala principal
            6246b7064f7a930001a76375 # Auditorio
          )

          git config user.name "Metanavarra"
          git config user.email "actions@users.noreply.github.com"

          DATE=$(date -Iseconds)

          for ROOM in $ROOMS; do
            echo $ROOM
          done

          for ROOM in $ROOMS; do
            echo $ROOM
            echo $ROOM
          done

          for ROOM in $ROOMS; do
            echo $ROOM;
            echo $ROOM;
          done

          for ROOM in $ROOMS; do
            curl --silent --header "Authorization: $CREDENTIALS" \
              "https://api.spatial.io/api/v1/rooms/?queryType=batch&roomIDs=$ROOM" \
            | jq > "$ROOM/$DATE.json"
            node check.js "$ROOM.json" "$ROOM/$DATE.json"
            ln -sf "$ROOM/$DATE.json" "$ROOM.json"
            git add $ROOM "$ROOM.json"
          done

          git commit --message="Toma de datos del $DATE"
      - name: Hace el «push»
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.token }}
