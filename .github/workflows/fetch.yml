name: De paseo por el metaverso más foral

on:
  push:
    paths:
      - '**.mjs'
      - '**.yml'
  schedule:
    - cron: '*/5 * * * *'

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Trae el repositorio
        uses: actions/checkout@v2
        with:
          persist-credentials: false
          fetch-depth: 0
      - name: Captura el estado de las salas
        env:
          TWITTER_CONSUMER_API_KEY: ${{ secrets.TWITTER_CONSUMER_API_KEY }}
          TWITTER_CONSUMER_API_SECRET: ${{ secrets.TWITTER_CONSUMER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
        run: |-
          CREDENTIALS="Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2NTI1MzY4MDEsImlhdCI6MTY1MjQ1MDQwMSwiaXNzIjoiaHR0cHM6Ly9hcGkuc3BhdGlhbC5pbyIsIm5vYXV0aCI6dHJ1ZSwicm9vbWlkIjoiNjI0NmI2OTY0ZjdhOTMwMDAxYTc2MzZhIiwic3ViIjoibm9hdXRofDYyN2U2NDYwMTNiODcxMDAwMTIwMjNhOSIsInVpZCI6IjYyN2U2NDYwMTNiODcxMDAwMTIwMjNhOSJ9.Ppal-0PPPr-zxg-D5e6VXIchwK9jjh1kLM-JRS2DLZM"

          git config user.name "Metanavarra"
          git config user.email "actions@users.noreply.github.com"

          DATE=$(date -Iseconds)

          curl --silent --header "Authorization: $CREDENTIALS" \
            "https://api.spatial.io/api/v1/rooms/?queryType=batch&roomIDs=6246b6964f7a930001a7636a&roomIDs=6246b7064f7a930001a76375" \
          | jq > "responses/$DATE.json"

          node check.mjs "latest.json" "responses/$DATE.json"

          ln -sf "responses/$DATE.json" latest.json

          git add responses latest.json
          git commit --message="Toma de datos del $DATE"
      - name: Hace el «push»
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.token }}
